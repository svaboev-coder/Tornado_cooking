# Устранение неполадок

## Проблема: Excel файл не обновляется

### Симптомы:
- Ошибка: `[Errno 13] Permission denied: 'backup_visitors.xlsx'`
- Новые данные не поступают в Excel файл
- В логах видны ошибки доступа к файлу

### Причины:
1. **Excel файл открыт в Microsoft Excel** - файл заблокирован для записи
2. **Файл открыт в другой программе** - например, в браузере или текстовом редакторе
3. **Недостаточно прав доступа** - программа не может записать в папку

### Решения:

#### 1. Закрыть Excel файл
```bash
# Завершить все процессы Excel
taskkill /f /im excel.exe
```

#### 2. Проверить, что файл не открыт
- Убедитесь, что файл `backup_visitors.xlsx` не открыт в Excel
- Закройте все программы, которые могут использовать этот файл

#### 3. Перезапустить бота
```bash
# Остановить бота (Ctrl+C)
# Затем запустить заново
python bot.py
```

#### 4. Проверить права доступа
- Убедитесь, что у программы есть права на запись в папку проекта
- Попробуйте запустить от имени администратора

### Профилактика:
- Не открывайте файл `backup_visitors.xlsx` в Excel во время работы бота
- Используйте копию файла для просмотра данных
- Регулярно проверяйте логи на наличие ошибок доступа

## Проблема: Ошибка подключения к базе данных

### Симптомы:
- `server closed the connection unexpectedly`
- `no connection to the server`
- Ошибки при получении данных

### Решения:
1. **Автоматическое переподключение** - бот автоматически переподключается к БД
2. **Перезапуск бота** - если автоматическое переподключение не помогло
3. **Проверка настроек БД** - убедитесь в правильности параметров в `.env`

## Проблема: Telegram API недоступен

### Симптомы:
- `ConnectTimeoutError`
- `Max retries exceeded`

### Решения:
1. **Проверка интернет-соединения**
2. **Проверка токена бота** - убедитесь в правильности токена в `.env`
3. **Перезапуск бота** - бот автоматически повторяет попытки подключения

## Проблема: Конфликт экземпляров бота

### Симптомы:
- `Error code: 409. Description: Conflict: terminated by other getUpdates request`
- `make sure that only one bot instance is running`
- Неожиданные ошибки в процессе регистрации
- Сообщения типа "❌ Выберите номер из списка корпуса" после ввода имени

### Причины:
1. **Несколько экземпляров бота запущены одновременно**
2. **Предыдущий экземпляр бота не был корректно завершен**
3. **Конфликт состояний пользователей между экземплярами**

### Решения:

#### 1. Завершить все процессы Python
```bash
# Завершить все процессы Python
taskkill /f /im python.exe
```

#### 2. Проверить запущенные процессы
```bash
# Проверить, какие процессы Python запущены
tasklist | findstr python
```

#### 3. Перезапустить бота
```bash
# Запустить бота заново
python bot.py
```

### Профилактика:
- Всегда завершайте бота корректно (Ctrl+C)
- Проверяйте, что нет других экземпляров перед запуском
- Используйте диспетчер задач для проверки запущенных процессов

## Полезные команды для диагностики:

### Проверка статуса бота:
```bash
python test_bot_status.py
```

### Проверка Excel файла:
```bash
python test_excel_update.py
```

### Финальная проверка всех функций:
```bash
python test_final_check.py
```

### Просмотр логов:
- Все ошибки записываются в консоль
- Обратите внимание на сообщения с уровнем ERROR

## Контакты для поддержки:
При возникновении проблем, которые не решаются данными инструкциями:
1. Сохраните логи ошибок
2. Опишите последовательность действий, приведших к ошибке
3. Укажите версию Python и операционной системы
